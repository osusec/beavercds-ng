---
apiVersion: v1
kind: Service
metadata:
  name: "rcds-{{ slug }}-{{ pod.name }}-tcp"
  namespace: "rcds-{{ slug }}"
  annotations:
    app.kubernetes.io/managed-by: rcds
    # still use separate domain for these, since exposed LoadBalancer services
    # will all have different ips from each other
    external-dns.alpha.kubernetes.io/hostname: "{{ name_slug }}.{{ domain }}"

    # aws-specific annotations for lb options
    service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: tcp
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-type: nlb
    service.beta.kubernetes.io/aws-load-balancer-manage-backend-security-group-rules: "true"

spec:
  type: LoadBalancer
  selector:
    rctf/part-of: "{{ slug }}-{{ pod.name }}"
  ports:
  {%- for p in tcp_ports %}
    - port: {{ p.expose.tcp }}
      targetPort: {{ p.internal }}
      protocol: TCP
  {% endfor -%}
